Using `maptools` - Proof of concept
===================================

Download TIGER 2012 shapefiles [here](http://www.census.gov/geo/maps-data/data/tiger-line.html). Store the shapefiles on the CHSE server in the "`DataRepository/Shapefiles/TIGER 2012`" folder. 

Resources:
* [Combining Spatial Data](http://cran.r-project.org/web/packages/maptools/vignettes/combine_maptools.pdf)
* [Maps in R -- Examples](http://geography.uoregon.edu/geogr/topics/maps.htm)
* [adding variable to shapefile](http://r-sig-geo.2731867.n2.nabble.com/adding-variable-to-shapefile-td6193408.html)

Load `maptools`
```{r LoadLibraries}
require(maptools, quietly=TRUE)
require(RColorBrewer, quietly=TRUE)
library(classInt, quietly=TRUE)
```

Read in the TIGER Zip Code Tabulation Area (ZCTA) shapefile. I'm not sure how the `proj4string` parameter works, but it fixes the projection.
```{r ReadShapefile}
dir <- "E:/DataRepository/Shapefiles/TIGER 2012/tl_2012_us_zcta510"
file <- paste(dir, "tl_2012_us_zcta510.shp", sep="/")
shpUS <- readShapePoly(file, proj4string=CRS("+proj=longlat"))
summary(shpUS)
```

Since ZCTAs do not exactly correspond to geographical units, we need to read in a ZCTA relationship file that links ZCTAs to states and counties. 
```{r ReadZCTARelFile}
dir <- "E:/DataRepository/Shapefiles/TIGER 2012/ZCTA Relationship Files"
file <- paste(dir, "zcta_county_rel_10.txt", sep="/")
zctarel <- read.table(file, header=TRUE, sep=",")
head(zctarel)
```

Create a character vector of ZCTAs and add it to the ZCTA relationship data frame. Then subset the ZCTA relationship file for Oregon ('STATE == 41' and ZCTA beginning with "97").
```{r SubsetZCTARelFile}
ZCTA5CHR <- sprintf("%05d", zctarel$ZCTA5)
zctarel <- data.frame(ZCTA5CHR, zctarel)
zctarelOR <- zctarel[zctarel$STATE == 41 & grepl("^97", zctarel$ZCTA5CHR),]
head(zctarelOR)
```

Subset the TIGER shapefile to include only the Oregon ZCTAs.
```{r SubsetShapefile}
shpOR <- subset(shpUS, ZCTA5CE10 %in% zctarelOR$ZCTA5)
summary(shpOR)
```

Merge the attributes from the ZCTA relationship file to the Oregon shapefile. Some ZCTAs span across counties. So we'll exclude the attributes that are county-specific; e.g., 2010 Population of the 2010 County (`COPOP`) and Total Area of the 2010 County (`COAREA`). The record file layout can be found [here](http://www.census.gov/geo/maps-data/data/zcta_rel_layout.html).
```{r MergeAttributes}
d1 <- shpOR@data
d2 <- subset(zctarelOR, select=c(ZCTA5CHR, ZCTA5, STATE, ZPOP, ZHU, ZAREA, ZAREALAND))
d <- merge(d1, d2, by.x="ZCTA5CE10", by.y="ZCTA5")
shpOR@data <- d
summary(shpOR)
```

Plot the Oregon ZCTAs.
```{r MapOR}
plot(shpOR, border="lightgrey")
```

Read in the CCO zip code data compiled by Peter Graven.
```{r ReadCCOData}
lookupCCO <- read.csv("//ohsum01.ohsu.edu/OHSU/OHSU Shared/Restricted/OCHSER/PROJECTS/EX13-04_Oregon_CO&CCOs/CCO Maps/Data/Zip CCO_edit.csv")
lookupCCO <- lookupCCO[order(lookupCCO$Zip_Code),]
head(lookupCCO)
```

Get the number of CCOs and create a [Color Brewer](http://colorbrewer2.org/) palette. Since the number of CCOs exceeds the maximum number of values possible in a palette, we'll need to create 3 separate palettes (red, green, blue) and concatenate them. Next, assign each CCO to a palette value.
```{r CreatePalette}
nCCO <- length(table(lookupCCO$CCO))
n <- ceiling(nCCO / 3)
palR <- brewer.pal(n, "Reds")
palG <- brewer.pal(n, "Greens")
palB <- brewer.pal(n, "Blues")
pal <- c(palR, palG[2:n], palB[2:n])
CCO <- names(table(lookupCCO$CCO))
pal <- data.frame(CCO, pal)
```

Define function to plot each CCO as a layer.
```{r DefineLayeringFunction}
layerCCO <- function(x) {
  l <- lookupCCO[lookupCCO$CCO == x, "Zip_Code"]
  c <- pal[pal$CCO == x, "pal"]
  shpx <- subset(shpOR, ZCTA5CE10 %in% l)
  plot(shpx, add=TRUE, col=c, border="lightgrey")
}
```

Run the layering function, iterating through all the CCOs. The function isn't smart enough to deal with ZCTAs that have multiple CCOs assigned.
```{r MapOregonCCO, fig.keep='last'}
plot(shpOR, border="lightgrey")
for (i in 4:6) {
  layerCCO(CCO[i])
}
```